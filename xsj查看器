<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>XSJ 查看器+导出器</title>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/dist/pouchdb.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb-load@7.2.2/dist/pouchdb.load.min.js"></script>
</head>
<body>
  <h2>拖入 .xsj.txt 文件</h2>
  <input type="file" id="fileInput" />
  <button id="exportBtn" disabled>导出 Markdown + 图片</button>
  <div id="status"></div>
  <script>
    let currentDB = null;

    async function saveFile(name, content) {
      const blob = new Blob([content]);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      a.click();
    }

    async function saveImage(name, blob) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'images/' + name;
      a.click();
    }

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('status').innerText = "加载中...";

      const text = await file.text();
      const dbname = 'xsj-view';
      const olddb = new PouchDB(dbname);
      await olddb.destroy();
      currentDB = new PouchDB(dbname);

      try {
        await currentDB.load(text);
        document.getElementById('status').innerText = "加载成功！现在可以点击“导出”";
        document.getElementById('exportBtn').disabled = false;
      } catch (err) {
        document.getElementById('status').innerText = "加载失败：" + err.message;
      }
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
      if (!currentDB) return;
      const allDocs = await currentDB.allDocs({include_docs: true, attachments: true, binary: true});
      let count = 0;
      for (const row of allDocs.rows) {
        const doc = row.doc;
        if (!doc || !doc.content) continue;
        const title = (doc.title || 'untitled-' + count).replace(/[\\/:*?"<>|]/g, '_');
        await saveFile(title + '.md', doc.content);

        // 导出附件
        if (doc._attachments) {
          for (const [attName, att] of Object.entries(doc._attachments)) {
            if (att.data) {
              const blob = new Blob([att.data], {type: att.content_type});
              await saveImage(attName, blob);
            }
          }
        }
        count++;
      }
      document.getElementById('status').innerText = `导出完成，共 ${count} 篇文档`;
    });
  </script>
</body>
</html>
